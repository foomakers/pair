name: Tag on Changeset PR Merge

on:
  pull_request_target:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  tag:
    # Only run when the PR was merged and it is a changeset-release branch
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'changeset-release/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use the workflow's token (GITHUB_TOKEN) which has minimal permissions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug PR information
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Head Ref: ${{ github.event.pull_request.head.ref }}"
          echo "PR Base Ref: ${{ github.event.pull_request.base.ref }}"
          echo "PR Merged: ${{ github.event.pull_request.merged }}"
          echo "Merge Commit SHA: ${{ github.event.pull_request.merge_commit_sha }}"
          echo "Head ref starts with changeset-release/: ${{ startsWith(github.event.pull_request.head.ref, 'changeset-release/') }}"

      - name: Determine merge commit
        id: merge
        run: |
          echo "merge_sha=${{ github.event.pull_request.merge_commit_sha }}" >> $GITHUB_OUTPUT

      - name: Determine monorepo version (highest bumped package)
        id: determine_version
        run: |
          set -euo pipefail
          sha="${{ steps.merge.outputs.merge_sha }}"
          # Collect changed package.json files from the merge commit
          files=$(git show --name-only --pretty="" "$sha" | grep -E '(^|/)(package.json)$' || true)
          if [ -z "$files" ]; then
            echo "No package.json changed in merge commit; exiting."
            exit 0
          fi
          echo "Changed package.json files:" >&2
          echo "$files" >&2
          versions=""
          for f in $files; do
            # Ensure file exists in repo (it should in merge commit)
            if [ ! -f "$f" ]; then
              # try extracting file from commit
              tmpver=$(git show "$sha":"$f" 2>/dev/null | jq -r .version || echo)
            else
              tmpver=$(jq -r .version "$f" 2>/dev/null || echo)
            fi
            if [ -n "$tmpver" ] && [ "$tmpver" != "null" ]; then
              echo "$tmpver"
              versions="$versions $tmpver"
            fi
          done
          # pick highest semver (sort -V works for semver on ubuntu)
          # sanitize versions list and pick last
          v=$(echo "$versions" | sed '/^$/d' | sort -V | tail -n1 || true)
          if [ -z "$v" ]; then
            echo "Could not determine a version from changed package.json files; exiting." >&2
            exit 0
          fi
          echo "version=$v" >> $GITHUB_OUTPUT
          echo "VERSION=$v" >> $GITHUB_ENV

      - name: Create monorepo tag (simplified)
        env:
          GIT_TAG_TOKEN: ${{ secrets.GH_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          sha="${{ steps.merge.outputs.merge_sha }}"
          echo "Merge commit SHA: $sha"

          # Try to get version from apps/pair-cli/package.json first
          if git show "$sha":apps/pair-cli/package.json >/dev/null 2>&1; then
            ver=$(git show "$sha":apps/pair-cli/package.json | jq -r .version)
            echo "Version from pair-cli package.json: $ver"
          else
            echo "Could not find pair-cli package.json in merge commit"
            exit 1
          fi

          # safety: trim whitespace/newlines from ver
          ver=$(echo "${ver}" | tr -d '\n' | tr -d '\r' | xargs || true)
          if [ -z "${ver}" ]; then
            echo "No version determined; skipping tag creation"
            exit 0
          fi

          tag="v${ver}"
          echo "Creating tag: $tag"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git rev-parse "refs/tags/$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists, skipping"
            exit 0
          fi

          git tag -a "$tag" -m "Release ${tag} (from changeset PR #${{ github.event.pull_request.number }})" "$sha"
          echo "Pushing tag $tag"
          git push "https://x-access-token:${GIT_TAG_TOKEN}@github.com/${{ github.repository }}" "refs/tags/$tag"
          echo "âœ… Created and pushed tag $tag"
